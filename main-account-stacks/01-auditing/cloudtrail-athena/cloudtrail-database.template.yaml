Parameters:
  CloudTrailTableName:
    Type: String
    Default: cloudtrail

Resources:
  CloudTrailTable:
    Properties:
      DatabaseName: !Ref AuditingGlueDatabase
      CatalogId: !Ref AWS::AccountId
      TableInput:
        Description: !Sub 'CloudTrail table for ${CloudTrailBucket} bucket'
        Name: !Ref CloudTrailTableName
        Parameters:
          classification: 'cloudtrail'
          EXTERNAL: 'TRUE'
        PartitionKeys:
          - Name: account
            Type: string
          - Name: region
            Type: string
          - Name: date
            Type: string
        StorageDescriptor:
          Columns:
          - Name: eventVersion
            Type: 'string'
          - Name: userIdentity
            Type: 'struct<type:string,principalId:string,arn:string,accountId:string,invokedBy:string,accessKeyId:string,userName:string,sessionContext:struct<attributes:struct<mfaAuthenticated:string,creationDate:string>,sessionIssuer:struct<type:string,principalId:string,arn:string,accountId:string,userName:string>>>'
          - Name: eventTime
            Type: 'string'
          - Name: eventSource
            Type: 'string'
          - Name: eventName
            Type: 'string'
          - Name: awsRegion
            Type: 'string'
          - Name: sourceIpAddress
            Type: 'string'
          - Name: userAgent
            Type: 'string'
          - Name: errorCode
            Type: 'string'
          - Name: errorMessage
            Type: 'string'
          - Name: requestParameters
            Type: 'string'
          - Name: responseElements
            Type: 'string'
          - Name: additionalEventData
            Type: 'string'
          - Name: requestId
            Type: 'string'
          - Name: eventId
            Type: 'string'
          - Name: resources
            Type: 'array<struct<arn:string,accountId:string,type:string>>'
          - Name: eventType
            Type: 'string'
          - Name: apiVersion
            Type: 'string'
          - Name: readOnly
            Type: 'string'
          - Name: recipientAccountId
            Type: 'string'
          - Name: serviceEventDetails
            Type: 'string'
          - Name: sharedEventID
            Type: 'string'
          - Name: vpcEndpointId
            Type: 'string'
          InputFormat: 'com.amazon.emr.cloudtrail.CloudTrailInputFormat'
          Location: !Sub 's3://${CloudTrailBucket}/'
          OutputFormat: 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
          NumberOfBuckets: -1
          SkewedInfo:
            SkewedColumnNames: []
            SkewedColumnValues: []
            SkewedColumnValueLocationMaps: {}
          SerdeInfo:
            Parameters:
              serialization.format: '1'
            SerializationLibrary: 'com.amazon.emr.hive.serde.CloudTrailSerde'
        TableType: EXTERNAL_TABLE
    Type: AWS::Glue::Table

  CloudTrailPartitioningTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: "partition"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "partition"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: 'true'

  CloudTrailPartitioning:
    From: Lambda
    Properties:
      Timeout: 30
      Principal: s3.amazonaws.com
      SourceAccount: !Ref AWS::AccountId
      Code: |
        {{code('partition.py')}}
      Environment:
        PartitionCheckTable: !Ref CloudTrailPartitioningTable
        CloudTrailTable: !Ref CloudTrailTableName
        AthenaQueryResults: !Ref AthenaQueryResults
        AuditingGlueDatabaseName: !Ref AuditingGlueDatabaseName
      Statements:
        - Sid: GlobalS3Permissions
          Effect: Allow
          Action:
            - s3:ListAllMyBuckets
            - s3:ListBucket
            - s3:HeadBucket
            - s3:ListObjects
          Resource: "*"
        - Sid: ResourceLevelS3Permissions
          Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:GetBucketLocation
          Resource:
            - !Sub ${CloudTrailBucket.Arn}/*
            - !GetAtt CloudTrailBucket.Arn
            - !Sub ${AthenaQueryResults.Arn}/*
            - !GetAtt AthenaQueryResults.Arn
        - Sid: Athena
          Effect: Allow
          Action:
            - athena:StartQueryExecution
            - athena:GetQueryExecution
          Resource: "*"
        - Sid: DynamoDB
          Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
          Resource: !GetAtt CloudTrailPartitioningTable.Arn
        - Sid: Glue
          Effect: Allow
          Action:
            - glue:GetDatabase
            - glue:GetTable
            - glue:BatchCreatePartition
          Resource: '*'
