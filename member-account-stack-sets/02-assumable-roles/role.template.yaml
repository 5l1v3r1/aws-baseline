Parameters:
  MFA:
    Type: String
    Default: true
    AllowedValues: [true, false]
  AllowedRegions:
    Type: String
    Default: 'us-east-1'
  MaxSessionDuration:
    Type: Number
    Default: 28800

Conditions:
  HasMFAEnabled: !Equals [true, !Ref MFA]
Resources:
  AdminPermissionsBoundary:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: AdminPermissionsBoundary
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowAdminAccess
            Effect: Allow
            Action: "*"
            Resource: "*"
          - {% include 'policy-statements/deny-stackset-actions.json'%}
          - {% include 'policy-statements/deny-stackset-cloudformation-actions.json'%}

  DeveloperPermissionsBoundary:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: DeveloperPermissionsBoundary
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowAdminAccess
            Effect: Allow
            Action: "*"
            Resource: "*"
          - {% include 'policy-statements/deny-stackset-actions.json'%}
          - {% include 'policy-statements/deny-stackset-cloudformation-actions.json'%}
          - {% include 'policy-statements/region-check.json'%}

  AssumableAdminRole:
    Properties:
      MaxSessionDuration: !Ref MaxSessionDuration
      AssumeRolePolicyDocument: {% include 'policy-statements/assumable-role-policy-document.json'%}
      PermissionsBoundary: !Ref AdminPermissionsBoundary
      Policies:
        - PolicyName: AdminAccess
          PolicyDocument:
            Version: '2008-10-17'
            Statement:
              - Sid: AdminAccess
                Effect: Allow
                Action:
                  - '*'
                Resource:
                  - '*'
      RoleName: AdminRole
    Type: AWS::IAM::Role

  AssumableReadOnlyRole:
    Properties:
      MaxSessionDuration: !Ref MaxSessionDuration
      AssumeRolePolicyDocument: {% include 'policy-statements/assumable-role-policy-document.json'%}
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/ReadOnlyAccess
      RoleName: ReadOnlyRole
    Type: AWS::IAM::Role

  AssumableDeveloperRole:
    Properties:
      MaxSessionDuration: !Ref MaxSessionDuration
      AssumeRolePolicyDocument: {% include 'policy-statements/assumable-role-policy-document.json'%}
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/ReadOnlyAccess
      Policies:
        - PolicyName: CloudFormation
          PolicyDocument:
            Version: '2008-10-17'
            Statement:
              - Sid: AllowCloudFormation
                Effect: Allow
                Action:
                  - cloudformation:*
                Resource:
                  - "*"
              - Sid: PassingRoleToCloudFormation
                Effect: Allow
                Action:
                  - iam:PassRole
                  - iam:GetRole
                Resource:
                  - !GetAtt CloudFormationRole.Arn
      RoleName: DeveloperRole
    Type: AWS::IAM::Role

  AssumableCloudFormationDeveloperRole:
    Properties:
      MaxSessionDuration: !Ref MaxSessionDuration
      AssumeRolePolicyDocument: {% include 'policy-statements/assumable-role-policy-document.json'%}
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/ReadOnlyAccess
      PermissionsBoundary: !Ref DeveloperPermissionsBoundary
      Policies:
        - PolicyName: CloudFormation
          PolicyDocument:
            Version: '2008-10-17'
            Statement:
              - Sid: AllowCloudFormation
                Effect: Allow
                Action:
                  - cloudformation:*
                Resource:
                  - "*"
              - Sid: PassingRoleToCloudFormation
                Effect: Allow
                Action:
                  - iam:PassRole
                  - iam:GetRole
                Resource:
                  - !GetAtt CloudFormationRole.Arn
      RoleName: CloudFormationDeveloperRole
    Type: AWS::IAM::Role

  CloudFormationRole:
    Properties:
      MaxSessionDuration: !Ref MaxSessionDuration
      AssumeRolePolicyDocument:
        Statement:
          Effect: Allow
          Principal:
            Service: cloudformation.amazonaws.com
          Action: sts:AssumeRole
      PermissionsBoundary: !Ref AdminPermissionsBoundary
      Policies:
        - PolicyName: CloudFormationRoleAdmin
          PolicyDocument:
            Version: '2008-10-17'
            Statement:
              - Sid: CloudFormationRoleAdmin
                Effect: Allow
                Action:
                  - '*'
                Resource:
                  - '*'
      RoleName: CloudFormationRole
    Type: AWS::IAM::Role


  AssumableSecurityAuditRole:
    Properties:
      MaxSessionDuration: !Ref MaxSessionDuration
      AssumeRolePolicyDocument: {% include 'policy-statements/assumable-role-policy-document.json'%}
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/SecurityAudit
      PermissionsBoundary: !Ref DeveloperPermissionsBoundary
      Policies:
        - PolicyName: SecurityAudit
          PolicyDocument:
            Version: '2008-10-17'
            Statement:
              - Action:
                  - support:DescribeTrustedAdvisorChecks
                Effect: Allow
                Resource: "*"
      RoleName: SecurityAuditRole
    Type: AWS::IAM::Role

  AssumableOperationsRole:
    Properties:
      MaxSessionDuration: !Ref MaxSessionDuration
      AssumeRolePolicyDocument: {% include 'policy-statements/assumable-role-policy-document.json'%}
      PermissionsBoundary: !Ref DeveloperPermissionsBoundary
      Policies:
        - PolicyName: Operations
          PolicyDocument:
            Version: '2008-10-17'
            Statement:
            - Action:
              - cloudwatch:Describe*
              - cloudwatch:Get*
              - cloudwatch:List*
              - logs:Describe*
              - logs:Get*
              - logs:List*
              - logs:FilterLogEvents
              - logs:StartQuery
              Effect: Allow
              Resource:
                - "*"
              Sid: AllowCloudWatchDevopsView
      RoleName: OperationsRole
    Type: AWS::IAM::Role

